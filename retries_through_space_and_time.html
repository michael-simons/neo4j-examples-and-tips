<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="Michael Simons">
<title>Try. And then retry. There can be failure.</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article">
<div id="header">
<h1>Try. And then retry. There can be failure.</h1>
<div class="details">
<span id="author" class="author">Michael Simons</span><br>
<span id="email" class="email"><a href="mailto:michael.simons@neo4j.com">michael.simons@neo4j.com</a></span><br>
<span id="revnumber">version unspecified</span>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>With persistent connections between things, the exceptional case should be expected and not considered to be a suprise.
There are dozends of reasons why a connection maybe closed or be rendered unusable.
In such scenarios precautions must be taken so that your logic succeeds eventually.</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_general_considerations"><a class="anchor" href="#_general_considerations"></a>1.1. General considerations</h3>
<div class="paragraph">
<p>Most database management systems (DBMS) these days provides client libraries aka drivers that provide stateful connections to the DBMS.
Establishing such connections includes among other things acquiring a transport link, a network session on both the client and the server and of course, user authentication.
These days connections are usually encrypted - or at least they should be - so the whole TLS ceremony, including certificate verification comes before that.
All that makes connections expensive.
Therefor once created, they are kept intact as long as it&#8217;s reasonable.</p>
</div>
<div class="paragraph">
<p>Having established and verified a connection once gives no guarantee that this connection will life for all time.
There are plenty of reasons that connection can become useless:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The physical connection fails</p>
</li>
<li>
<p>The server goes away</p>
</li>
<li>
<p>Parts of the server being in use go away (i.e. the members of a cluster)</p>
</li>
<li>
<p>The server figures that the connection has not been used and terminates it</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the Java world <a href="https://en.wikipedia.org/wiki/Java_Database_Connectivity">JDBC</a> is an established standard for connecting to relational databases.
JDBC connections are seldomly handled in isolation from within an application but most often through <a href="https://en.wikipedia.org/wiki/Connection_pool">connection pools</a>.
In connection pooling, after a connection is created, it is placed in the pool and it is used again so that a new connection does not have to be established. If all the connections are being used, a new connection is made and is added to the pool.
Connection pools can also be configured to verify or test connections before they handle out a lease.</p>
</div>
<div class="paragraph">
<p>Depending on the pool, this might or might not safe you from the pain when a connection went away.
The pool can create a new one, hand it out and you&#8217;re good to go.</p>
</div>
<div class="paragraph">
<p>This is all fine when you execute things on the connection that finish in small amounts of time or at least way before a connection may fail.
It won&#8217;t help you with longer running transactions, involving multiple calls on a connection.
The first calls may succeed, the next one fails.
A pool cannot not do anything here, when it handed out the connection, it worked.</p>
</div>
<div class="paragraph">
<p><strong>To sum this up</strong>: Stateful connections are costly to acquire and there are many good reasons to keep them around.
Connection failures however are not something extraordinary, they happen.
As a developer you have to create your application in such a way that it is able to mitigate connection failures.
There are various tools that help you with the basic connection management in pools.
When things fail in mid flight, it is up to you to decide whether you want to fail hard or retry a transaction.</p>
</div>
</div>
<div class="sect2">
<h3 id="_neo4j"><a class="anchor" href="#_neo4j"></a>1.2. Neo4j</h3>
<div class="sect3">
<h4 id="_why_is_this_topic_important"><a class="anchor" href="#_why_is_this_topic_important"></a>1.2.1. Why is this topic important?</h4>
<div class="paragraph">
<p>Neo4j can be run as a database cluster, not only make it very scalable but also very resilient against the occasional loss of a server or changes in infrastructure.
Clients are usually routed to one of the members of a cluster that fulfills the needs of that client (either read only operations or read and write operations).
If the member to which the client is connected goes away, the cluster itself takes care of finding a new quorum on the state of things, but the client needs to handle the exceptional state:
A stateful connection that has become stale.</p>
</div>
<div class="paragraph">
<p>That becomes even more relevant in big cloud deployments of the Neo4j database, such as <a href="https://console.neo4j.io">Neo4j Aura</a>,
in which the members of a cluster are rotated quite often.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_neo4j_driver"><a class="anchor" href="#_the_neo4j_driver"></a>1.2.2. The Neo4j driver</h4>
<div class="paragraph">
<p><em>I am writing this post from a Java perspective, thus I mainly focus on the <a href="https://github.com/neo4j/neo4j-java-driver">Neo4j Java driver</a>, but the core aspects apply for each supported driver.</em></p>
</div>
<div class="paragraph">
<p>The Neo4j driver objects do connection pooling for you.
You point them to a server or a cluster and they create an internal connection pool for you.
With <code>.session()</code> (or <code>.asyncSession()</code> respectively <code>.rxSession()</code>) on the driver object, a session with an underlying connection will be acquired and handed to you.</p>
</div>
<div class="paragraph">
<p>If there are no more connections in the pool or if the connections are closed, a new one is created.</p>
</div>
<div class="paragraph">
<p>Work in that sessions happens inside transactions.
All the time.</p>
</div>
<div class="paragraph">
<p>Transactions are atomic units of work containing one or more Cypher Queries.
Transactions may contain read or write work, and will generally be routed to an appropriate server for execution, where they will be carried out in their entirety.
In case of a transaction failure, the transaction needs to be retried from the beginning.</p>
</div>
<div class="paragraph">
<p>The driver offers two modes in which the transaction management is done for you and one mode where you are responsible.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll find the following information in the drivers manual <a href="https://neo4j.com/docs/driver-manual/current/cypher-workflow/#driver-transactions">under "Transactions"</a>.</p>
</div>
<div class="sect4">
<h5 id="_automatic_commits"><a class="anchor" href="#_automatic_commits"></a>Automatic commits</h5>
<div class="paragraph">
<p>This is simplest form: You run one query directly on the session.
Opening a transaction before and commiting it afterwards it&#8217;s done for you.
This is probably also the most shortlived form of a transaction, depending only on how long your single query takes to run.</p>
</div>
<div class="paragraph">
<p>Either way: Not only is the transaction managed for you but also making sure the session and it&#8217;s underlying physical connection is usuable is done for you.
This all happens in one go.
The query will however not be retried if the connection breaks done during execution.</p>
</div>
</div>
<div class="sect4">
<h5 id="_transactional_functions"><a class="anchor" href="#_transactional_functions"></a>Transactional functions</h5>
<div class="paragraph">
<p>All the drivers provide an API that takes in a unit of work, defined in the corresponding language.
In the Java world that is a functional interface called <code>TransactionWork&lt;T&gt;</code> with a single method called <code>T execute(Transaction tx)</code>.
<code>T</code> represents a type parameter (the type of the object returned by the unit of work) and the one and only parameter is the ongoing transaction.</p>
</div>
<div class="paragraph">
<p>Those functions can be passed around inside the driver and they can be retried when things fail during execution.
Failure can happen as described before (the acquisition of the physical connection fails) or inflight (connection is lost).</p>
</div>
<div class="paragraph">
<p>To allow the driver to safely execute those functions multiple times, they are some hard requirements:
The functions must be idempotent and are not allowed to return an unconsumed result set from any ongoing query.
Idempotency should be an obvious requirement: The function may be applied multiple times until success and it shouldn&#8217;t have a different outcome on the second run than at first try.
The second requirement may not be that obvious.
The function will use the passed <code>Transaction</code> object to execute queries.
The result of those queries is tied to that transaction.
The transaction will be closed after the function ran, in both failure and success states.
At that very moment, the behaviour of the result will become undetermined, as it is tied to the transaction.
If the method returns anything from it, than it must be mapped into a stable object before the end of the functions.</p>
</div>
</div>
<div class="sect4">
<h5 id="_unmanaged_transaction"><a class="anchor" href="#_unmanaged_transaction"></a>Unmanaged transaction</h5>
<div class="paragraph">
<p>Unmanaged transactions work by opening a session (which will ensure that at this very moment a working connection can be established),
and than explicitly opening up a transaction with <code>beginTransaction()</code>, working on it and commiting as see fit.</p>
</div>
<div class="paragraph">
<p>This is the way many higher level abstraction will use the driver.
Such abstractions - like Spring Data Neo4j - use transactions managed by the application itself and translate them into database transactions accordingly.
<a href="https://twitter.com/mp911de">Mark Paluch</a> and I spoke at Devoxx 2019 about those topics, find our <a href="https://www.youtube.com/watch?v=8TkY_RaoLCQ">reactive transaction master class here</a>.</p>
</div>
<div class="paragraph">
<p>Unmanaged transactions provide freedom of interaction with the database transactions as necessary - for example keeping it open as long as a large result set is streamed and processed further - but delegate the responsiblity in case of failures back to the client.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_examples"><a class="anchor" href="#_examples"></a>2. Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following examples are all Java based and use Spring Boot as an application runtime.
The reason for that: I work in the team that is responsible for our Spring integration and in the end, I can write idiomatic Java much better than say idiomatic Python or Go.
The main ideas should be portable.</p>
</div>
<div class="paragraph">
<p>The examples all work in the Neo4j movie graph. For your convenience I have added the <a href="https://github.com/michael-simons/neo4j-migrations">Neo4j migrations</a> to the setup of each project.
It creates the dataset for you.</p>
</div>
<div class="paragraph">
<p>Each of the different services offer a read REST service under <code><a href="http://localhost:8080/api/movies" class="bare">http://localhost:8080/api/movies</a></code>, giving you a list of movies.
A second endpoint, <code><a href="http://localhost:8080/api/movies/watched/" class="bare">http://localhost:8080/api/movies/watched/</a></code> takes a movie title and "watches" it. This endpoint requires authentication as <code>couchpotato</code> with password secret.</p>
</div>
<div class="paragraph">
<p>All three example services use the same <code>MovieController</code> to orchestrate a <code>MovieService</code> looking like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">MovieService</span> {

        <span class="predefined-type">Collection</span>&lt;Movie&gt; getAllMovies();

        <span class="predefined-type">Integer</span> watchMovie(<span class="predefined-type">String</span> userName, <span class="predefined-type">String</span> title);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementations of the movie service, especially <code>watchMovie</code> is bloated and complicated <strong>on purpose</strong>.
The general flow is first getting the movie, than getting the person that is authenticated and than updating the number of times the movie is watched.
I know how to write this in one query, but the idea is to have a slight window of time in which I can kill the connection or introduce arbitrary failure.</p>
</div>
<div class="paragraph">
<p>All the following examples are available on Github:
<a href="https://github.com/michael-simons/neo4j-sdn-ogm-tips/tree/master/examples/retries-through-space-and-time">Neo4j Java Driver rety examples</a>.</p>
</div>
<div class="sect2">
<h3 id="_shared_configuration"><a class="anchor" href="#_shared_configuration"></a>2.1. Shared configuration</h3>
<div class="paragraph">
<p>The examples share the following configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Config.builder()
                .withMaxConnectionLifetime(<span class="integer">5</span>, <span class="predefined-type">TimeUnit</span>.MINUTES)
                .withMaxConnectionPoolSize(<span class="integer">1</span>)
                .withLeakedSessionsLogging();</code></pre>
</div>
</div>
<div class="paragraph">
<p>or expressed as properties in Spring Boot 2.3 with our <a href="https://github.com/neo4j/neo4j-java-driver-spring-boot-starter">starter</a> on the classpath</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">org.neo4j.driver.pool.max-connection-lifetime=5m
org.neo4j.driver.pool.metrics-enabled=true
org.neo4j.driver.pool.log-leaked-sessions=true
org.neo4j.driver.pool.max-connection-pool-size=1</code></pre>
</div>
</div>
<div class="paragraph">
<p>or with Spring Boot 2.4 upwards as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">spring.neo4j.pool.max-connection-lifetime=5m
spring.neo4j.pool.metrics-enabled=true
spring.neo4j.pool.log-leaked-sessions=true
spring.neo4j.pool.max-connection-pool-size=1</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is <strong>NOT</strong> a configuration I recommend in any form in production.
Especially the pool size effectivley disables the pool, but allows for easy testing our retries via Neo4j&#8217;s <code>dbms.listConnections() and `dbms.killConnection()</code> functions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_application_using_the_java_driver"><a class="anchor" href="#_application_using_the_java_driver"></a>2.2. Application using the Java driver</h3>
<div class="paragraph">
<p>This describes the application named <a href="https://github.com/michael-simons/neo4j-sdn-ogm-tips/tree/master/examples/retries-through-space-and-time/driver_with_tx_function">driver_with_tx_function</a> in the GitHub repository.
It depends on <code>spring-boot-starter-web</code>, <code>spring-boot-starter-security</code> and <code>neo4j-java-driver-spring-boot-starter</code> which gives you the Neo4j Java driver.</p>
</div>
<div class="paragraph">
<p>Given the service holds an instance of <code>org.neo4j.driver.Driver</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Service</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieService</span> {

        <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> Log log = LogFactory.getLog(MovieService.class);

        <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Driver</span> driver;

        MovieService(<span class="predefined-type">Driver</span> driver) {
                <span class="local-variable">this</span>.driver = driver;
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>the function reading all the movies can be implemented like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;Movie&gt; getAllMovies() {

    TransactionWork&lt;<span class="predefined-type">List</span>&lt;Movie&gt;&gt; readAllMovies = tx -&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
        Function&lt;Record, Movie&gt; recordToMovie =
            r -&gt; <span class="keyword">new</span> Movie(r.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">m</span><span class="delimiter">&quot;</span></span>).get(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>).asString()); <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="keyword">return</span> tx.run(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (m:Movie) RETURN m ORDER BY m.title ASC</span><span class="delimiter">&quot;</span></span>)
            .list(recordToMovie); <i class="conum" data-value="3"></i><b>(3)</b>
        };

    <span class="keyword">try</span> (Session session = driver.session()) {
        <span class="keyword">return</span> session.readTransaction(readAllMovies); <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is a transactional function, a unit of work</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A mapping function, extracted for readability</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The only interaction with the database</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The actual moment the unit of work is passed to the driver</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The whole unit of work is basically atomic. It doesn&#8217;t modify state, so it is safe to retry.
The result set is consumed before the unit of work is left (via <code>list</code>).
When passed to <code>readTransaction</code> the driver tries to execute it for a maximum of 30s by default.</p>
</div>
<div class="paragraph">
<p>The ceremony looks very similar in terms of a write scenario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="predefined-type">Integer</span> watchMovie(<span class="predefined-type">String</span> userName, <span class="predefined-type">String</span> title) {

    TransactionWork&lt;<span class="predefined-type">Integer</span>&gt; watchMovie = tx -&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

        var userId = tx.run( <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE (u:Person {name: $name}) RETURN id(u)</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, userName)
            ).single().get(<span class="integer">0</span>).asLong();

        var movieId = tx.run(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE (m:Movie {title: $title}) RETURN id(m)</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, title)
        ).single().get(<span class="integer">0</span>).asLong();

        InsertRandom.delay(); <i class="conum" data-value="3"></i><b>(3)</b>

        var args = <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">movieId</span><span class="delimiter">&quot;</span></span>, movieId, <span class="string"><span class="delimiter">&quot;</span><span class="content">userId</span><span class="delimiter">&quot;</span></span>, userId);
        <span class="keyword">return</span> tx.run(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
            + <span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (m:Movie), (u:Person)</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>
            + <span class="string"><span class="delimiter">&quot;</span><span class="content">WHERE id(m) = $movieId AND id(u) = $userId WITH m, u</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>
            + <span class="string"><span class="delimiter">&quot;</span><span class="content">MERGE (u) - [w:WATCHED] -&gt; (m)</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>
            + <span class="string"><span class="delimiter">&quot;</span><span class="content">SET w.number_of_times = COALESCE(w.number_of_times,0)+1</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>
            + <span class="string"><span class="delimiter">&quot;</span><span class="content">RETURN w.number_of_times AS number_of_times</span><span class="delimiter">&quot;</span></span>, args)
            .single().get(<span class="string"><span class="delimiter">&quot;</span><span class="content">number_of_times</span><span class="delimiter">&quot;</span></span>).asInt();
        };

        <span class="keyword">try</span> (Session session = driver.session()) {
            <span class="keyword">return</span> session.writeTransaction(watchMovie); <i class="conum" data-value="4"></i><b>(4)</b>
        }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The unit of work</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Split onto multiple queries to have some window for disaster</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>With some random delay added as well</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The actual call, this time in a <code>writeTransaction</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All the merges in those queries will be commited or none at all.
Care must be taken not calling a stored procedure that does internal commits or using a statement with <code>PERIODIC COMMIT</code>.</p>
</div>
<div class="paragraph">
<p>The execution of the <code>watchMovie</code> unit of work will be retried for 30 seconds by default.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s look at Spring&#8217;s <code>@Transactional</code>, Object-Database-Mapper like <a href="https://neo4j.com/docs/ogm-manual/current/">Neo4j-OGM</a> and value adding <a href="https://spring.io/projects/spring-data-neo4j">Spring Data Neo4j</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_application_using_neo4j_ogm_and_spring_data_inside_spring_transactions"><a class="anchor" href="#_application_using_neo4j_ogm_and_spring_data_inside_spring_transactions"></a>2.3. Application using Neo4j-OGM and Spring Data inside Spring transactions</h3>
<div class="paragraph">
<p>The following is about <a href="https://github.com/michael-simons/neo4j-sdn-ogm-tips/tree/master/examples/retries-through-space-and-time/sdn_ogm">sdn_ogm</a>.</p>
</div>
<div class="paragraph">
<p>Spring offers a declarative way to define transactional boundaries in the service layer of an application via the <code>@Transactional</code> annotation.
This depends of course on Spring&#8217;s <code>TransactionManager</code>.
In Springs case this <code>TransactionManager</code> is responsible for the scope and propagation of a transaction and also on which type of exceptions things should be rolled back.</p>
</div>
<div class="paragraph">
<p>Springs transaction manager has no builtin understanding of retries.</p>
</div>
<div class="paragraph">
<p>In addition to <code>@Transactional</code>, Spring transactions can also be used with the <code>TransactionTemplate</code>, but the above restrictions stay valid.</p>
</div>
<div class="paragraph">
<p>Assume an OGM based service like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Service</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieServiceBasedOnPureOGM</span> <span class="directive">implements</span> MovieService {

        <span class="directive">private</span> <span class="directive">final</span> org.neo4j.ogm.session.Session session;

        <span class="directive">public</span> MovieServiceBasedOnPureOGM(Session session) {
                <span class="local-variable">this</span>.session = session;
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>session</code> is not a Driver, but an OGM session!</p>
</div>
<div class="paragraph">
<p>Looking at the read method above implemented with OGM we find</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transactional</span>(readOnly = <span class="predefined-constant">true</span>)
<span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;Movie&gt; getAllMovies() {

    <span class="keyword">return</span> session.loadAll(Movie.class);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s no way to use the drivers builtin retries.
The same is true for the write case. Again, please note that this is of course implemented badly to test out retries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transactional</span>
<span class="directive">public</span> <span class="predefined-type">Integer</span> watchMovie(<span class="predefined-type">String</span> userName, <span class="predefined-type">String</span> title) {

    var user = Optional.ofNullable(
            session.queryForObject(
                User.class,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (u:Person) -[w:WATCHED] -&gt; (m:Movie) WHERE u.name = $name RETURN u, w, m</span><span class="delimiter">&quot;</span></span>,
                <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, userName)
            )).orElseGet(() -&gt; <span class="keyword">new</span> User(userName));

    var movie = Optional.ofNullable(
            sessiom.queryForObject(
                Movie.class,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (m:Movie) WHERE m.title = $title RETURN m</span><span class="delimiter">&quot;</span></span>,
                <span class="predefined-type">Map</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, title))
            ).orElseGet(() -&gt; <span class="keyword">new</span> Movie(title));

    InsertRandom.delay();

    <span class="type">int</span> numberOfTimes = user.watch(movie);
    session.save(user);
    <span class="keyword">return</span> numberOfTimes;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>getAllMovies</code> and <code>watchMovie</code> now defines our transactional units of work, as the lambdas in the previous section did before.</p>
</div>
<div class="paragraph">
<p>To avoid defining custom queries completly, we can swap the interaction with the session with Spring Data reposiories like that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Service</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieServiceBasedOnSDN</span> <span class="directive">implements</span> MovieService {

    <span class="type">interface</span> <span class="class">MovieRepository</span> <span class="directive">extends</span> Neo4jRepository&lt;Movie, <span class="predefined-type">Long</span>&gt; {

        Optional&lt;Movie&gt; findOneByTitle(<span class="predefined-type">String</span> title);
    }

    <span class="type">interface</span> <span class="class">UserRepository</span> <span class="directive">extends</span> Neo4jRepository&lt;User, <span class="predefined-type">Long</span>&gt; {

        Optional&lt;User&gt; findOneByName(<span class="predefined-type">String</span> name);
    }

    <span class="directive">private</span> <span class="directive">final</span> MovieRepository movieRepository;

    <span class="directive">private</span> <span class="directive">final</span> UserRepository userRepository;

    <span class="directive">public</span> MovieServiceBasedOnSDN(MovieRepository movieRepository, UserRepository userRepository) {
        <span class="local-variable">this</span>.movieRepository = movieRepository;
        <span class="local-variable">this</span>.userRepository = userRepository;
    }

    <span class="annotation">@Override</span> <span class="annotation">@Transactional</span>(readOnly = <span class="predefined-constant">true</span>)
    <span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;Movie&gt; getAllMovies() {

        <span class="keyword">return</span> (<span class="predefined-type">Collection</span>&lt;Movie&gt;) movieRepository.findAll();
    }

    <span class="annotation">@Override</span> <span class="annotation">@Transactional</span>
    <span class="directive">public</span> <span class="predefined-type">Integer</span> watchMovie(<span class="predefined-type">String</span> userName, <span class="predefined-type">String</span> title) {

        var user = userRepository.findOneByName(userName)
            .orElseGet(() -&gt; <span class="keyword">new</span> User(userName));

        var movie = movieRepository.findOneByTitle(title)
            .orElseGet(() -&gt; <span class="keyword">new</span> Movie(title));

        InsertRandom.delay();

        <span class="type">int</span> numberOfTimes = user.watch(movie);
        userRepository.save(user);
        <span class="keyword">return</span> numberOfTimes;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transactional units of work stay the same and it reads better but there&#8217;s still no way we can facilitate the drivers builtin retry mechanism.</p>
</div>
<div class="paragraph">
<p>As explained earlier: Expect those things to fail!
With the code in place, you can do this on the calling side like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PostMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/watched</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">Integer</span> watched(<span class="predefined-type">Principal</span> principal, <span class="annotation">@RequestBody</span> <span class="predefined-type">String</span> title) {

    <span class="keyword">try</span> {
        <span class="keyword">return</span> <span class="local-variable">this</span>.movieService.watchMovie(principal.getName(), title);
    } <span class="keyword">catch</span>(<span class="exception">Exception</span> e) {
        <span class="keyword">throw</span> <span class="keyword">new</span> ResponseStatusException(HttpStatus.I_AM_A_TEAPOT);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or do retries on your own in the catch block.
Regardless of what you do: It is the applications responsibility to handle these errors!</p>
</div>
<div class="paragraph">
<p>One way of doing this is a library named <a href="https://resilience4j.readme.io">Resilience4j</a>.
Resilience4j is a lightweight fault tolerance library inspired by Netflix Hystrix, but designed for functional programming.</p>
</div>
<div class="paragraph">
<p>The library offers not only retries, but also <a href="https://en.wikipedia.org/wiki/Circuit_breaker">circuit breakers</a>, bulkheads and more.
In generally, it offers several ways to make your application more resillient against inevitable exceptional states.</p>
</div>
<div class="paragraph">
<p>The easiest way add Resilience4j to your Spring project is via a starter: <code>io.github.resilience4j:resilience4j-spring-boot2:1.5.0</code>.
In addition, you have to add <code>org.springframework.boot:spring-boot-starter-aop</code> to enable the declarative usage via <code>@Retry</code></p>
</div>
<div class="paragraph">
<p>Those dependencies gives you property support to configure Resilience4j and provides all beans necessary in the Spring context.</p>
</div>
<div class="paragraph">
<p>Resilience4j can be configured programmatically but we are gonna use the provided configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties"># This is represents the default config
resilience4j.retry.configs.default.max-retry-attempts=10
resilience4j.retry.configs.default.wait-duration=1s
# Those are the same exceptions the driver itself would retry on
resilience4j.retry.configs.default.retry-exceptions=\
  org.neo4j.driver.exceptions.SessionExpiredException,\
  org.neo4j.driver.exceptions.ServiceUnavailableException

# Only to make log entries appear immediate
resilience4j.retry.configs.default.event-consumer-buffer-size=1

resilience4j.retry.instances.neo4j.base-config=default</code></pre>
</div>
</div>
<div class="paragraph">
<p>This creates a retry object named <code>neo4j</code> which tries 10 attempts and waits for a second in between.
It only retries on exceptions of the given type.</p>
</div>
<div class="paragraph">
<p>An exponential backoff interval can be enabled by setting <code>resilience4j.retry.configs.default.enable-exponential-backoff=true</code>.</p>
</div>
<div class="paragraph">
<p>How to use this?</p>
</div>
<div class="paragraph">
<p>If you want to stick with the declarative way, all you have to do is annotate the service class as a whole or individual methods with <code>@Retry(name = "neo4j")</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">io.github.resilience4j.retry.annotation.Retry</span>;

<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Service</span>;
<span class="keyword">import</span> <span class="include">org.springframework.transaction.annotation.Transactional</span>;

<span class="annotation">@Service</span>
<span class="annotation">@Retry</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieServiceBasedOnPureOGM</span> <span class="directive">implements</span> MovieService {

        <span class="directive">private</span> <span class="directive">final</span> org.neo4j.ogm.session.Session session;

        <span class="directive">public</span> MovieServiceBasedOnPureOGM(Session session) {
                <span class="local-variable">this</span>.session = session;
        }

    <span class="annotation">@Transactional</span>(readOnly = <span class="predefined-constant">true</span>)
    <span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;Movie&gt; getAllMovies() {

        <span class="comment">// See above</span>
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

    <span class="annotation">@Transactional</span>
    <span class="directive">public</span> <span class="predefined-type">Integer</span> watchMovie(<span class="predefined-type">String</span> userName, <span class="predefined-type">String</span> title) {
                <span class="comment">// See above</span>
        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s effectively all there is.</p>
</div>
<div class="paragraph">
<p>If you prefer doing it in a programmatic way without using annotations, you can inject the registry of <code>Retry</code> objects into the calling side and run your transactional unit of work like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">io.github.resilience4j.retry.RetryRegistry</span>;

<span class="keyword">import</span> <span class="include">java.security.Principal</span>;
<span class="keyword">import</span> <span class="include">java.util.Collection</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.tips.cluster.sdn_ogm.domain.Movie</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.tips.cluster.sdn_ogm.domain.MovieService</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.GetMapping</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.PostMapping</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.RequestBody</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.RequestMapping</span>;
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.RestController</span>;

<span class="annotation">@RestController</span>
<span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/movies</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">MovieController</span> {

    <span class="directive">private</span> <span class="directive">final</span> MovieService movieService;

    <span class="directive">private</span> <span class="directive">final</span> RetryRegistry retryRegistry;

    <span class="directive">public</span> MovieController(MovieService movieService, RetryRegistry retryRegistry) {
        <span class="local-variable">this</span>.movieService = movieService;
        <span class="local-variable">this</span>.retryRegistry = retryRegistry;
    }

    <span class="annotation">@GetMapping</span>({ <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> })
    <span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;Movie&gt; getMovies() {
        <span class="keyword">return</span> retryRegistry.retry(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
            .executeSupplier(<span class="local-variable">this</span>.movieService::getAllMovies); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span class="annotation">@PostMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/watched</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">public</span> <span class="predefined-type">Integer</span> watched(<span class="predefined-type">Principal</span> principal, <span class="annotation">@RequestBody</span> <span class="predefined-type">String</span> title) {

        <span class="keyword">return</span> retryRegistry.retry(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>)
            .executeSupplier(() -&gt; <span class="local-variable">this</span>.movieService.watchMovie(principal.getName(), title));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the configured retry</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Chose one of the fitting methods and execute your service</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please note that you <strong>cannot</strong> do this inside the service method annotated with <code>@Transactional</code>.
If you would, you would get the boundaries exactly the wrong way: The retry would happen inside the transaction.
You want to have the transaction retried.</p>
</div>
<div class="paragraph">
<p>The Neo4j driver itself does retry on two additional cases: When it receceives a transient exception from the server with two well defined error codes.
This is rather easy to replicate by a Java <code>Predicate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">RetryOGMSDNExceptionPredicate</span> <span class="directive">implements</span> <span class="predefined-type">Predicate</span>&lt;<span class="predefined-type">Throwable</span>&gt; {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> test(<span class="predefined-type">Throwable</span> throwable) {

        <span class="predefined-type">Throwable</span> ex = throwable;
        <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> CypherException) {
            ex = throwable.getCause();
        }

        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> TransientException) {
            <span class="predefined-type">String</span> code = ((TransientException) ex).code();
            <span class="keyword">return</span> !<span class="string"><span class="delimiter">&quot;</span><span class="content">Neo.TransientError.Transaction.Terminated</span><span class="delimiter">&quot;</span></span>.equals(code) &amp;&amp;
                !<span class="string"><span class="delimiter">&quot;</span><span class="content">Neo.TransientError.Transaction.LockClientStopped</span><span class="delimiter">&quot;</span></span>.equals(code);
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> ex <span class="keyword">instanceof</span> SessionExpiredException || ex <span class="keyword">instanceof</span> <span class="exception">ServiceUnavailableException</span>;
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As OGM happens to wrap exceptions it catches into <code>CypherException</code> we can unwrap those as well.</p>
</div>
<div class="paragraph">
<p>To add this predicate to your Resilience4j config, add this to your configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">resilience4j.retry.configs.default.retry-exception-predicate=\
  your.package.RetrySDN6ExceptionPredicate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: We&#8217;re gonna add a prebuild predicate to OGM that you can use for your convinience.</p>
</div>
</div>
<div class="sect2">
<h3 id="_application_using_spring_data_neo4j_6_inside_spring_transactions"><a class="anchor" href="#_application_using_spring_data_neo4j_6_inside_spring_transactions"></a>2.4. Application using Spring Data Neo4j 6 inside Spring transactions</h3>
<div class="paragraph">
<p>The upcoming version 2.4 of Spring Boot will contain a completly revamped Spring Data Neo4j without Neo4j-OGM but still containing all the mapping features.
The same application using a milestone of SDN 6 (formelly known as SDN/RX) is available as <a href="https://github.com/michael-simons/neo4j-sdn-ogm-tips/tree/master/examples/retries-through-space-and-time/sdn6">sdn6</a>.</p>
</div>
<div class="paragraph">
<p>The predicate looks a bit different, but all the rest applies.</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_examples"><a class="anchor" href="#_running_the_examples"></a>2.5. Running the examples</h3>
<div class="paragraph">
<p>The examples require Java 11.</p>
</div>
<div class="paragraph">
<p>I have build a <a href="https://github.com/michael-simons/neo4j-sdn-ogm-tips/tree/master/examples/retries-through-space-and-time/client">simple client</a>.
Built and run it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./mvnw clean compile
./mvnw exec:java -Dexec.mainClass=&quot;org.neo4j.tips.cluster.client.Application&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will keep on calling <code>localhost:8080</code> and expects one of the services running.</p>
</div>
<div class="paragraph">
<p>To run the pure driver based server or the SDN/OGM examples, use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./mvnw spring-boot:run -Dspring-boot.run.arguments=&quot;--org.neo4j.driver.uri=neo4j://YOUR_DATABASE:7687 --org.neo4j.driver.authentication.password=YOURPASSWORD&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To run the SDN 6 example, the properties are a bit different</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./mvnw spring-boot:run -Dspring-boot.run.arguments=&quot;--spring.neo4j.uri=neo4j://YOUR_DATABASE:7687 --spring.neo4j.authentication.password=YOURPASSWORD&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the the SDN/OGM respectively the SDN 6 example use the repository abstraction, add <code>--spring.profiles.active=use-sdn</code> to the run arguments.</p>
</div>
<div class="paragraph">
<p>All applications provide metrics for the driver (how many connections have been created) under <a href="http://localhost:8080/actuator/metrics/neo4j.driver.connections.created" class="bare">http://localhost:8080/actuator/metrics/neo4j.driver.connections.created</a>.</p>
</div>
<div class="paragraph">
<p>The SDN/OGM and the SDN 6 application that use Resilience4j provide additional metrics about retries, such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://localhost:8080/actuator/metrics/resilience4j.retry.calls" class="bare">http://localhost:8080/actuator/metrics/resilience4j.retry.calls</a></p>
</li>
<li>
<p><a href="http://localhost:8080/actuator/metrics/resilience4j.retry.calls?tag=kind:successful_without_retry" class="bare">http://localhost:8080/actuator/metrics/resilience4j.retry.calls?tag=kind:successful_without_retry</a></p>
</li>
<li>
<p><a href="http://localhost:8080/actuator/metrics/resilience4j.retry.calls?tag=kind:successful_with_retry" class="bare">http://localhost:8080/actuator/metrics/resilience4j.retry.calls?tag=kind:successful_with_retry</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>3. Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Neo4j Java Driver and libraries such as Neo4j-OGM and Spring Data Neo4j works just fine against Neo4j clusters and cloud solutions like Aura.
All three transaction modes (auto commit, managed and unmanaged transactions) can be used.
A library using unmanaged transactions just works perfectly normal.</p>
</div>
<div class="paragraph">
<p>However, applications must plan and prepare for connection failures - regardless whether the database is deployed standalone or as a cluster.
This is normal.
Connection failures can be mitigated by using built-in retry mechanisms of our drivers or using external solutions.</p>
</div>
<div class="paragraph">
<p>In the Java world, you have to options to deal with this for Neo4j: Using the builtin offering or a tool like Resilience4j.
Resilience4j allows shaping those retries in a very fine grained way.
We haven discussed what happens at the nth retry: Either the thing fails completly or an alternative is called.
Such a last resort would keep services available for the users with retries enabled later on.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version unspecified<br>
Last updated 2022-02-28 10:09:54 UTC
</div>
</div>
</body>
</html>